#!/bin/bash
#SBATCH --job-name=KinSim_cGAN_Extract
#SBATCH --cpus-per-task=1
#SBATCH --mem=16G
#SBATCH --account=p774
#SBATCH --partition=pibu_el8
#SBATCH --time=24:00:00
#SBATCH --output=/data/projects/p774_MARSD/NDutilleux/logs/kinsim_cgan_extract_%A_%a.log
#SBATCH --mail-user=nicolas.dutilleux@unifr.ch
#SBATCH --mail-type=FAIL

# ============================================================
# KinSim cGAN — Extract raw samples + merge (two-phase SLURM job)
#
# This script handles BOTH phases automatically:
#   Phase 1 (array job):  Extract raw (IPD, PW) samples from one BAM
#   Phase 2 (single job): Merge all shards into master_cgan_data.pkl
#                         — submitted automatically by the last array task
#
# Usage:
#   sbatch --array=1-N kinsim_cgan_extract.slurm <config> <shards_dir> <master_output>
#
# The merge job is submitted automatically when all array tasks finish.
# No second command needed.
#
# Arguments:
#   $1  Config file (alternating lines: BAM path / motif string)
#       Generate with: kinsim prepare pairs.txt config_strains.txt
#   $2  Directory for *_cgan.pkl shards (intermediate files)
#   $3  Path for the final merged training data (e.g. /data/kinsim/master_cgan_data.pkl)
#
# Example:
#   sbatch --array=1-57 kinsim_cgan_extract.slurm config_strains.txt cgan_shards/ master_cgan_data.pkl
#
# Expected directory structure:
#   project/
#     config_strains.txt        <- generated by kinsim prepare
#     cgan_shards/              <- intermediate *_cgan.pkl shards
#       strain1_cgan.pkl
#       strain2_cgan.pkl
#     master_cgan_data.pkl      <- final merged training data
#     logs/                     <- SLURM logs
#
# Output is consumed by:
#   kinsim_cgan_train.slurm    (trains the Generator + Discriminator)
#
# To merge two existing master datasets (e.g. adding new strains):
#   kinsim cgan merge <dir_with_both_pkls> <combined_master.pkl>
# ============================================================

# ---- Usage check ----
if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ]; then
    echo "Usage: sbatch --array=1-N kinsim_cgan_extract.slurm <config> <shards_dir> <master_output>"
    echo ""
    echo "Arguments:"
    echo "  config             Alternating lines: BAM path / motif string"
    echo "                     Generate with: kinsim prepare pairs.txt config_strains.txt"
    echo "  shards_dir         Directory for intermediate *_cgan.pkl shard files"
    echo "  master_output      Path for the final merged training data (.pkl)"
    echo ""
    echo "Example:"
    echo "  sbatch --array=1-57 kinsim_cgan_extract.slurm config_strains.txt cgan_shards/ master_cgan_data.pkl"
    exit 1
fi

# ---- Environment ----
source ~/.bashrc
conda activate kinsim_env

# ---- Config ----
CONFIG_FILE="$1"
SHARDS_DIR="$2"
MASTER_OUTPUT="$3"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "ERROR: Config file '$CONFIG_FILE' not found."
    exit 1
fi

# ---- Phase detection ----
if [ -n "$SLURM_ARRAY_TASK_ID" ]; then
    # ============ PHASE 1: Extract one shard ============
    mkdir -p "$SHARDS_DIR"

    BAM_PATH=$(sed -n "$(( ($SLURM_ARRAY_TASK_ID * 2) - 1 ))p" "$CONFIG_FILE")
    MOTIFS=$(sed -n "$(( $SLURM_ARRAY_TASK_ID * 2 ))p" "$CONFIG_FILE")

    BASENAME=$(basename "$BAM_PATH" .bam)
    OUTPUT_PKL="${SHARDS_DIR}/${BASENAME}_cgan.pkl"

    echo "=== PHASE 1: Extract ==="
    echo "Task $SLURM_ARRAY_TASK_ID / $SLURM_ARRAY_TASK_MAX: $BAM_PATH"
    echo "Motifs: $MOTIFS"
    echo "Output: $OUTPUT_PKL"

    kinsim cgan extract "$BAM_PATH" "$MOTIFS" "$OUTPUT_PKL"

    # The last array task auto-submits the merge job.
    # Suppressed when KINSIM_NO_AUTOMERGE=1 (used by kinsim_pipeline.sh, which
    # submits the merge explicitly so it can chain further dependency jobs).
    if [ "$SLURM_ARRAY_TASK_ID" -eq "$SLURM_ARRAY_TASK_MAX" ] && [ -z "${KINSIM_NO_AUTOMERGE}" ]; then
        echo ""
        echo "Last array task — submitting merge job (dependency: afterok:${SLURM_ARRAY_JOB_ID})..."
        sbatch --dependency=afterok:"${SLURM_ARRAY_JOB_ID}" \
            "$0" "$CONFIG_FILE" "$SHARDS_DIR" "$MASTER_OUTPUT"
    fi
else
    # ============ PHASE 2: Merge all shards ============
    echo "=== PHASE 2: Merge ==="
    echo "Shards dir: $SHARDS_DIR"
    echo "Master output: $MASTER_OUTPUT"

    MASTER_DIR=$(dirname "$MASTER_OUTPUT")
    mkdir -p "$MASTER_DIR"

    kinsim cgan merge "$SHARDS_DIR" "$MASTER_OUTPUT"
fi
