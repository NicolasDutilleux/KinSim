#!/bin/bash
#SBATCH --job-name=KinSim_Train
#SBATCH --cpus-per-task=1
#SBATCH --mem=16G
#SBATCH --account=p774
#SBATCH --partition=pibu_el8
#SBATCH --time=24:00:00
#SBATCH --output=logs/kinsim_train_%A_%a.log
#SBATCH --mail-user=nicolas.dutilleux@unifr.ch
#SBATCH --mail-type=FAIL

# ============================================================
# KinSim Dictionary — Train shards + merge (two-phase SLURM job)
#
# This script handles BOTH phases:
#   Phase 1 (array job):  Train one .pkl shard per BAM
#   Phase 2 (single job): Merge all shards into master_dict.pkl
#
# Usage (two-step submission):
#   TRAIN=$(sbatch --parsable --array=1-N kinsim_train.slurm <config> <shards_dir> <master_output>)
#   sbatch --dependency=afterok:$TRAIN kinsim_train.slurm <config> <shards_dir> <master_output>
#
# Arguments:
#   $1  Config file (alternating lines: BAM path / motif string)
#       Generate with: kinsim prepare pairs.txt config_strains.txt
#   $2  Directory for .pkl shards (intermediate files)
#   $3  Path for the final merged dictionary (e.g. /data/kinsim/master_dict.pkl)
#
# How it works:
#   - When SLURM_ARRAY_TASK_ID is set  → trains one shard into $2
#   - When SLURM_ARRAY_TASK_ID is unset → merges $2/*.pkl into $3
#
# Example:
#   TRAIN=$(sbatch --parsable --array=1-53 kinsim_train.slurm config_strains.txt shards/ /data/kinsim/master_dict.pkl)
#   sbatch --dependency=afterok:$TRAIN kinsim_train.slurm config_strains.txt shards/ /data/kinsim/master_dict.pkl
#
# Expected directory structure:
#   project/
#     config_strains.txt        <- generated by kinsim prepare
#     shards/                   <- intermediate .pkl shards
#       strain1_binary.pkl
#       strain2_binary.pkl
#     master_dict.pkl           <- final merged dictionary
#     logs/                     <- SLURM logs
#
# To merge two existing master dicts (e.g. adding new data):
#   kinsim dictionary merge <dir_with_both_pkls> <combined_master.pkl>
# ============================================================

# ---- Usage check ----
if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ]; then
    echo "Usage:"
    echo "  TRAIN=\$(sbatch --parsable --array=1-N kinsim_train.slurm <config> <shards_dir> <master_output>)"
    echo "  sbatch --dependency=afterok:\$TRAIN kinsim_train.slurm <config> <shards_dir> <master_output>"
    echo ""
    echo "Arguments:"
    echo "  config             Alternating lines: BAM path / motif string"
    echo "                     Generate with: kinsim prepare pairs.txt config_strains.txt"
    echo "  shards_dir         Directory for intermediate .pkl shard files"
    echo "  master_output      Path for the final merged dictionary (.pkl)"
    echo ""
    echo "Expected structure:"
    echo "  project/"
    echo "    config_strains.txt"
    echo "    shards/             <- intermediate shards"
    echo "    master_dict.pkl     <- final merged output"
    echo "    logs/"
    exit 1
fi

# ---- Environment ----
source ~/.bashrc
conda activate kinsim_env

# ---- Config ----
CONFIG_FILE="$1"
SHARDS_DIR="$2"
MASTER_OUTPUT="$3"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "ERROR: Config file '$CONFIG_FILE' not found."
    exit 1
fi

# ---- Phase detection ----
if [ -n "$SLURM_ARRAY_TASK_ID" ]; then
    # ============ PHASE 1: Train one shard ============
    mkdir -p "$SHARDS_DIR"

    BAM_PATH=$(sed -n "$(( ($SLURM_ARRAY_TASK_ID * 2) - 1 ))p" "$CONFIG_FILE")
    MOTIFS=$(sed -n "$(( $SLURM_ARRAY_TASK_ID * 2 ))p" "$CONFIG_FILE")

    BASENAME=$(basename "$BAM_PATH" .bam)
    OUTPUT_PKL="${SHARDS_DIR}/${BASENAME}_binary.pkl"

    echo "=== PHASE 1: Train ==="
    echo "Task $SLURM_ARRAY_TASK_ID: $BAM_PATH"
    echo "Motifs: $MOTIFS"
    echo "Output: $OUTPUT_PKL"

    kinsim dictionary train "$BAM_PATH" "$MOTIFS" "$OUTPUT_PKL"
else
    # ============ PHASE 2: Merge all shards ============
    echo "=== PHASE 2: Merge ==="
    echo "Shards dir: $SHARDS_DIR"
    echo "Master output: $MASTER_OUTPUT"

    MASTER_DIR=$(dirname "$MASTER_OUTPUT")
    mkdir -p "$MASTER_DIR"

    kinsim dictionary merge "$SHARDS_DIR" "$MASTER_OUTPUT"
fi
